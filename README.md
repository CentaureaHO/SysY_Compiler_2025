# SysY 编译器 2025编译系统实现赛参赛项目

此为2025年计算机系统能力大赛编译系统实现赛，老师菜菜捞捞队的参赛项目。 项目使用C++语言实现了一个SysY语言到RiscV后端的编译器。

项目地址：https://gitlab.eduxiji.net/T202510055206450/compiler2025-lsccll

## 关于运行此项目

需要的外部依赖：
1. flex
2. bison

运行以下命令，以获取并编译此项目，并使用此编译器编译SysY语言到RiscV汇编代码。
```
git clone https://gitlab.eduxiji.net/T202510055206450/compiler2025-lsccll
cd compiler2025-lsccll/
make
./bin/compiler -S -o output_file_path input_file_path -O1
```

或者在编译此项目后，运行以下命令来使用自动化脚本完成测试。

```
python3 test.py  input_case_folder  output_folder  1 S
```


## 关于此编译器的设计

### 项目架构
```
.
|——─ include //头文件
|       |—— ast //语法树相关
|       |     └ ......
|       |—— backend //riscv后端相关
|       |    └ ......
|       |—— common 
|       |    |—— array //关于数组索引转换 
|       |    |—— type //关于语法树中数据类型，符号表等
|       |    |      |—— symtab //符号表定义
|       |    |      |—— type_defs.h
|       |    |      |—— type_calc.h
|       |    |——str_convert.h //词法分析时字符串值的计算
|       |
|       |—— llvm_ir //关于中间代码生成
|       |    |—— instructions.h //中间代码指令定义
|       |    |—— ...... //其他结构定义
|       |       
|       |—— parser //关于词法语法分析
|       |    |—— ......
|       |—— str //关于打印语法树
|
│———— lib
|
|———— optimize //关于优化
|       |—— llvm //中端优化
|       |     |—— ......
|       |——......
|———— parser
|       |—— lexer.l //词法分析
|       |—— yacc.y //语法分析
|
|———— src // 头文件中定义的实现 结构同include
|       |—— ......
| 
|———— utils //辅助代码
|
|———— Makefile
|———— main.cpp
|———— test.py
└─——— ......
```

### 词法分析
本项目中，我们使用flex完成词法分析，实现输入字符流到token流的转换。

### 语法分析
本项目中，我们使用bison完成语法分析，通过产生式的语义动作创建语法树节点并连接，实现由输入token流构造语法树。

### 中间代码生成
本项目的中间代码生成分为两步完成，首先进行语义分析，过程中对指令的数据类型是否匹配，是否存在除以0、变量重复定义、无main函数等不合法情况进行检查，对程序中不合法位置进行报错，并对语法树做一些预处理，以方便中间代码的生成。

接下来进行实际的中间代码生成，对语法树节点附加打印中间代码的语义动作，生成中间代码时从语法树根节点递归地向下调用，完成中间代码生成，实现从语法树生成LLVM IR字节流直接输出或输出定义的LLVM IR指令流。


### 目标代码生成
经一系列中端优化后，以LLVM IR指令流生成RiscV后端代码，目标代码生成部分主要包括指令选择与寄存器分配两部分，指令选择即为LLVM IR指令选择对应的RiscV指令，以实现编译出实际后端平台上的代码，此时使用的寄存器仍然为虚拟寄存器。

指令选择完毕后，对此时的目标代码进行寄存器分配，本项目中目前使用线性扫描方法完成寄存器的分配。

## 关于性能与优化

在此项目中，我们完成了丰富的中端优化，优化按Pass组织，具有较好的可扩展性，并达到了较优的性能。

### 中端完成的优化
1. dce
2. adce
3. cse（公共子表达式消除）
4. mem2reg
5. 循环查找（loop find）
6. 循环规范化（loop simplify）
7. 闭环形式SSA（LCSSA）
8. 循环不变量外提（标量，call，mem）
9. 函数内联
10. 尾递归优化
11. 稀疏条件常量传播
12. 算术指令强度削减（算术指令，GEP指令（地址运算扁平化））
13. loop rotate
14. GCM
15. SCEV
16. 归纳变量简化
17. 强度削弱（乘法，GEP）
18. 常量循环完全展开

### 后端完成的优化

## 关于参考

https://github.com/yuhuifishash/SysY
